---
title: "MB2 Demographic Data Processing"
format: html
---

```{r}
library(tidyverse)
library(here)
library(assertthat)
library(fuzzyjoin)
 
source(here('helper','ensure_repo_structure.R'))
```

```{r download}
source(here('helper', 'osf_download.R'))
gather_osf_data("qv5hb", DEMO_DATA_DIR)
```

```{r}
  
demo_files <- setdiff(dir(here(DEMO_DATA_DIR)), c('webcam_exclusions'))
adults <- demo_files[str_detect(demo_files, "adults")]
toddlers <- demo_files[str_detect(demo_files, "toddlers")]

setdiff(demo_files, c(adults, toddlers))
assert_that(length(demo_files) == length(adults) + length(toddlers))
```

Note that despite validation we still didn't end up get perfectly valid data. BUT - better than MB1!!!

```{r}
adult_demo <- adults |>
  map_df(function(fname) {
    print(fname)
    read_csv(here(DEMO_DATA_DIR, fname),
             show_col_types = FALSE)  |>
      mutate(education = as.character(education),
             testing_date = as.character(testing_date),
             test_order = as.character(test_order),
             test2_error_info = as.character(test2_error_info),
             ra_id = as.character(ra_id), 
             age_years = as.character(age_years),
             participant_id = as.character(participant_id),
             test_order = as.character(test_order)) |>
      select(labid:bear_knowledge_info) |>
    mutate(participant_id = paste0(participant_id, "_adults"))
  }) 
```

Fix our sadness.

```{r}
adult_demo <- adult_demo |>
  mutate(age_years_n = as.numeric(age_years))
bla <- adult_demo %>% filter(is.na(age_years_n))
```

Toddlers next.

```{r}
columns_to_character <- c("gestation_week", "lang2_exposure","lang3_exposure",
                          "fam1_error_info","fam2_error_info","fam3_error_info",
                          "ra_id","hours_children",
                          "testing_date","sibling3_age","hours_daycare",
                          "hours_parentA","hours_parentB","hours_siblings",
                          "hours_adults", "sibling1_age", "sibling2_age", 
                          "parentB_education", "sibling4_age", "sibling5_age", 
                          "lang4_exposure", "parentA_education", 
                          "test2_error_info", "participant_id", 
                         "hours_other",
                         "lang1_exposure","fam4_error_info","test1_error_info")
                          
toddler_demo <- toddlers |>
  map_df(function(fname) {
    print(fname)
    read_csv(here(DEMO_DATA_DIR, fname),
             show_col_types = FALSE) %>% 
      mutate(hours_other = {if("hours_other" %in% names(.)) hours_other else 0}) %>% # REMOVE THIS ONCE beinghumanWroclaw has provided the hours_other column
       mutate(across(columns_to_character, as.character)) |>
      select(labid:anything_else)
  }) |> mutate(participant_id = paste0(participant_id, "_toddlers"))
```

We will need to fix these.

Also: there is a mismatch of `labid` and `lab_id` that needs to be fixed.

```{r}
toddler_demo <- rename(toddler_demo, lab_id = labid)
adult_demo <- rename(adult_demo, lab_id = labid)
```

## Demographics

Age histogram.

Based on spot checks, it appears that these are real kids who just fall outside of age range.

```{r}
days_in_month = 365.25/12
ggplot(toddler_demo, aes(x = age_days/days_in_month, fill = lab_id)) + 
  geom_histogram() + 
  theme(legend.position = "bottom")
```
```{r}
toddler_demo
```


## Correct lab_ids

Use website/airtable canonical lab IDs for correction

```{r}
lab_ids <- read_csv(here("metadata","labids.csv")) |>
  rename(lab_id = LabID) 

adult_demo <- fuzzyjoin::stringdist_left_join(adult_demo, lab_ids, 
                by = "lab_id", 
                max_dist = 1, 
                ignore_case = TRUE) |>
  mutate(lab_id.y = case_when(lab_id.x == "BLT_Trento" ~ "babylabTrento",
                              lab_id.x == "PLUS" ~ "ToMcdlSalzburg",
                              TRUE ~ lab_id.y)) |>
  rename(lab_id = lab_id.y) |>
  select(-lab_id.x)


toddler_demo <- fuzzyjoin::stringdist_left_join(toddler_demo, lab_ids, 
                by = "lab_id", 
                max_dist = 1, 
                ignore_case = TRUE) |>
  mutate(lab_id.y = case_when(lab_id.x == "BLT_Trento" ~ "babylabTrento",
                              lab_id.x == "UHH" ~ "kokuHamburg",
                              lab_id.x == "PLUS" ~ "ToMcdlSalzburg",
                              TRUE ~ lab_id.y)) |>
  rename(lab_id = lab_id.y) |>
  select(-lab_id.x)

assert_that(!any(is.na(toddler_demo$lab_id)))
assert_that(!any(is.na(adult_demo$lab_id)))
```
# Descriptives

These are completely unfiltered. 

```{r}
print(paste0("num labs: ",length(unique(c(toddler_demo$lab_id, adult_demo$lab_id)))))


print(paste0("num toddler participants: ", nrow(toddler_demo)))
print(paste0("num adult participants: ", nrow(adult_demo)))


unique(c(toddler_demo$`🌍 Country`, adult_demo$`🌍 Country`))

```
Ages. 

```{r}
age_mo <- (toddler_demo$age_days / 365)*12

print(paste0("mean toddler age: ", mean(age_mo, na.rm=TRUE)))
print(paste0("sd: ", sd(age_mo, na.rm=TRUE)))

```


# Saving

```{r saving}
save(adult_demo, file = here(INTERMEDIATE_FOLDER, INTERMEDIATE_001_ADULT))
save(toddler_demo, file = here(INTERMEDIATE_FOLDER, INTERMEDIATE_001_TODDLER))
```

# Exclusions

Note to write out a table here.
