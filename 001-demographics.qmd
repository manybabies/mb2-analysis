---
title: "MB2 Demographic Data Processing"
format: html
---

```{r}
library(tidyverse)
library(here)
library(assertthat)
library(fuzzyjoin)
 
source(here('helper','ensure_repo_structure.R'))
```

```{r download}
source(here('helper', 'osf_download.R'))
gather_osf_data("qv5hb", DEMO_DATA_DIR)
```

```{r}
demo_files <- setdiff(dir(here(DEMO_DATA_DIR)), c('webcam_exclusions'))
adults <- demo_files[str_detect(demo_files, "adults")]
toddlers <- demo_files[str_detect(demo_files, "toddlers")]

setdiff(demo_files, c(adults, toddlers))
assert_that(length(demo_files) == length(adults) + length(toddlers))
```

Note that we iterated through several steps of processing the processed data (even after validation) due to various issues with unifying the processed data. This resulted in correcting many demographics files by hand, mostly fixing parsing errors in how commas were handled in converting all files to .csvs.

We also convert several columns to character vectors, due to inconsistencies in how some numeric and character columns were handled

```{r}
adult_columns_to_character <- c("age_years","education","test2_error_info","test_order","ra_id"
)

adult_demo <- adults |>
  map_df(function(fname) {
    print(fname)
    read_csv(here(DEMO_DATA_DIR, fname),
             show_col_types = FALSE)  |>
      mutate(across(all_of(adult_columns_to_character), as.character)) |>
    mutate(participant_id = paste0(participant_id, "-adults"))
  }) 
```

Fix our sadness (sadness maybe fixed?).

```{r}
adult_demo <- adult_demo |>
  mutate(age_years_n = as.numeric(age_years))
```

Toddlers next.

```{r}
toddler_columns_to_character <- c("gestation_week","lang1_exposure","lang2_exposure","lang3_exposure","lang4_exposure","sibling1_age","sibling2_age","sibling3_age","fam1_error_info","fam2_error_info","fam3_error_info","fam4_error_info","ra_id","hours_children","hours_daycare","hours_other","hours_parentA","hours_parentB","hours_siblings","hours_adults","sibling4_age","sibling5_age","parentA_education","parentB_education","age_days","test1_error_info","test2_error_info","participant_id")
                          
toddler_demo <- toddlers |>
  map_df(function(fname) {
    print(fname)
    read_csv(here(DEMO_DATA_DIR, fname),
             show_col_types = FALSE) %>% 
       mutate(across(all_of(toddler_columns_to_character), as.character)) #|>
      #select(labid:anything_else)
  }) |> mutate(participant_id = paste0(participant_id, "-toddlers"))
```

Also: there is a mismatch of `labid` and `lab_id` that needs to be fixed.

```{r}
toddler_demo <- rename(toddler_demo, lab_id = labid)
adult_demo <- rename(adult_demo, lab_id = labid)
```

## Demographics

Age histogram.

Based on spot checks, it appears that these are real kids who just fall outside of age range.

```{r}
days_in_month = 365.25/12

toddler_demo <- toddler_demo |>
  mutate(age_days_num=as.numeric(age_days))

ggplot(toddler_demo, aes(x = age_days_num/days_in_month, fill = lab_id)) + 
  geom_histogram() + 
  theme(legend.position = "bottom")
```

## Correct lab_ids

Use website/airtable canonical lab IDs for correction

```{r}
lab_ids <- read_csv(here("metadata","labids.csv")) |>
  rename(lab_id = LabID) 

adult_demo <- fuzzyjoin::stringdist_left_join(adult_demo, lab_ids, 
                by = "lab_id", 
                max_dist = 1, 
                ignore_case = TRUE) |>
  mutate(lab_id.y = case_when(lab_id.x == "BLT_Trento" ~ "babylabTrento",
                              lab_id.x == "PLUS" ~ "ToMcdlSalzburg",
                              TRUE ~ lab_id.y)) |>
  rename(lab_id = lab_id.y) |>
  select(-lab_id.x)


toddler_demo <- fuzzyjoin::stringdist_left_join(toddler_demo, lab_ids, 
                by = "lab_id", 
                max_dist = 1, 
                ignore_case = TRUE) |>
  mutate(lab_id.y = case_when(lab_id.x == "BLT_Trento" ~ "babylabTrento",
                              lab_id.x == "UHH" ~ "kokuHamburg",
                              lab_id.x == "PLUS" ~ "ToMcdlSalzburg",
                              TRUE ~ lab_id.y)) |>
  rename(lab_id = lab_id.y) |>
  select(-lab_id.x)

assert_that(!any(is.na(toddler_demo$lab_id)))
assert_that(!any(is.na(adult_demo$lab_id)))
```

Clean up this merge.

```{r}
adult_demo <- adult_demo |>
  rename(institution = `🏫 Institution`,
         country = `🌍 Country`) |>
  select(-`Lab Name`, -`PI(s)`, -`Additional Members`, -`Lab website`, 
         -`📚 Projects (collecting data)`)

toddler_demo <- toddler_demo |>
    rename(institution = `🏫 Institution`,
         country = `🌍 Country`) |>
  select(-`Lab Name`, -`PI(s)`, -`Additional Members`, -`Lab website`, 
         -`📚 Projects (collecting data)`)

  
```

# Descriptives

These are completely unfiltered.

```{r}
print(paste0("num labs: ",length(unique(c(toddler_demo$lab_id, adult_demo$lab_id)))))


print(paste0("num toddler participants: ", nrow(toddler_demo)))
print(paste0("num adult participants: ", nrow(adult_demo)))


unique(c(toddler_demo$country, adult_demo$country))

```

Ages.

```{r}
age_mo <- (toddler_demo$age_days_num / 365)*12

print(paste0("mean toddler age: ", mean(age_mo, na.rm=TRUE)))
print(paste0("sd: ", sd(age_mo, na.rm=TRUE)))

```

# Saving

```{r saving}
save(adult_demo, file = here(INTERMEDIATE_FOLDER, INTERMEDIATE_001_ADULT))
save(toddler_demo, file = here(INTERMEDIATE_FOLDER, INTERMEDIATE_001_TODDLER))
```
