---
title: "MB2 Pilot Analysis"
author: "The ManyBabies Analysis Team"
date: '`r format(Sys.time(), "%a %b %d %X %Y")`'
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: yes
editor_options: 
  chunk_output_type: inline
---

```{r libraries}
suppressMessages(library(here))
suppressMessages(library(jpeg))
suppressMessages(library(grid))
suppressMessages(library(lmerTest))
suppressMessages(library(car))
suppressMessages(library(brms))

source(here::here("helper/common.R"))
source(here("helper/preprocessing_helper.R"))

#knitr::opts_chunk$set(cache = TRUE, warn = FALSE, message = FALSE)
```


# Intro

Pilot data analysis for MB2.

We can re-preprocess all of our data, this is set not to evaluate by default. In order to do this, you will need to register with Eyelink to get their binary package and then install `edfR`.

```{r, eval=FALSE, warning=FALSE, message=FALSE}

# labs <- dir(here::here("pilot_data"))
# 
# for (lab in labs) {
#   print(lab)
#   source(here::here("pilot_data", lab, "import_scripts", "import.R"))
# }

```


# File reading

```{r}
labs <- dir(here::here("pilot_data"))

d <- labs %>%
  map_df(function(lab) {
    aoi_data <- read_csv(here(paste0("pilot_data/",
                                     lab,"/processed_data/aoi_data.csv"))) 
    subjects <- read_csv(here(paste0("pilot_data/",
                                     lab,"/processed_data/subjects.csv"))) 
    trials <- read_csv(here(paste0("pilot_data/",
                                   lab,"/processed_data/trials.csv"))) 
    datasets <- read_csv(here(paste0("pilot_data/",
                                     lab,"/processed_data/datasets.csv")))
    
    left_join(aoi_data, subjects) %>%
      left_join(trials) %>%
      left_join(datasets) %>%
      select(lab_subject_id, lab_dataset_id, lab_trial_id, trial_id, 
             age, t, aoi, trial_num, error, experiment_num, sex) %>%
      rename(subid = lab_subject_id, 
             lab = lab_dataset_id, 
             stimulus = lab_trial_id) %>%
      mutate(aoi = case_when(grepl("target", aoi) ~ "target",
                             grepl("distractor", aoi) ~ "distractor",
                             is.na(aoi) == F ~ "other")
             )
  })
```

# Exclusions

```{r}
d$experiment = case_when(str_detect(d$experiment_num, "1b") ~ "pilot_1b",
                         d$experiment_num == "pilot_1a" ~ "pilot_1a_kid",
                         d$experiment_num == "pilot_1a_adult" ~ "pilot_1a_adult")

# exclude subject marked with any error and/or less than 8 trials
d <- d %>% 
  group_by(lab, subid, experiment_num) %>%
  mutate(error_subj = any(error)) %>%
      exclude_by(quo(error_subj), quiet=FALSE) 

# exclude trials under 32s (which are not complete trials)
# changed from 35s to 32 after pilot 1b because no_outcome
# trials are shorter
d <- ungroup(d) %>% 
  group_by(lab, trial_id, subid, experiment) %>%
  mutate(time_range = (max(t) - min(t))/1000) %>%
          exclude_by(quo(time_range <= 32), quiet=FALSE)

# print trial time ranges by lab
ungroup(d) %>%
  group_by(lab, experiment) %>% 
  summarise(shortest_trial=min(time_range),
            longest_trial=max(time_range)) %>%
  kable(digits=2)

# exclude subjects who did not complete at least 7 trials
d <- ungroup(d) %>% 
  group_by(lab, subid, experiment) %>%
  mutate(trials_completed = length(unique(trial_id))) %>%
           exclude_by(quo(trials_completed < 7),quiet=FALSE) %>% 
  mutate(subid = paste(subid, lab, experiment, sep="_"))

```

# Descriptive Analysis

Descriptives

```{r}
d %>%
  group_by(experiment, lab, subid) %>%
  summarise(age = mean(age)) %>%
  summarise(n = n(),
            age = mean(age)/30.25) %>%
  kable(digits = 2)

#mean age, min and max age
d %>%  
  distinct(subid, .keep_all = TRUE) %>% 
  group_by(experiment) %>% 
  summarise(n = n(), 
            age = mean(age, na.rm = TRUE)/30.25,
            min_age = min(age, na.rm = TRUE)/30.25,
            max_age = max(age, na.rm = TRUE)/30.25) #some pilot 1b lab has NA for age...

# sex  
d %>%  
  distinct(subid, .keep_all = TRUE) %>% 
  group_by(experiment, sex) %>% 
  tally() 

```

Anticipation plot across all trials. 

```{r}
ms <- d %>% 
  group_by(t, trial_num, experiment_num) %>%
  summarise(target = mean(aoi == "target", na.rm=TRUE),
            distractor = mean(aoi == "distractor", na.rm=TRUE)) %>%
  gather(region, looking, target, distractor) 

ggplot(ms, aes(x = t, y = looking, col = region)) + 
  geom_line() + 
  geom_vline(xintercept = 120, col = "red", lty = 2) + 
  facet_grid(experiment_num ~ .) + 
  coord_cartesian(xlim = c(-4000+120, 4120)) #only consider the 4sec window before and after POD

```    

In the primary time period of interest

```{r}
ms <- d %>%
  group_by(t, experiment_num) %>%
  summarise(target = mean(aoi == "target", na.rm = TRUE),
            distractor = mean(aoi == "distractor", na.rm = TRUE)) %>%
  gather(region, looking, target, distractor) 
  
ggplot(ms, aes(x = t, y = looking, col = region)) +
  geom_point() + 
  xlim(-4000 + 120, 4000 + 120) + 
  geom_vline(xintercept = 120, col = "red", lty = 2) + 
  geom_text(x = -4000, y = .95, group = 1, col = "black", 
            label = "Anticipation", hjust = 0) + 
  geom_text(x = 200, y = .95, group = 1, col = "black", 
            label = "Reaction", hjust = 0) + 
  facet_grid(. ~ experiment_num)
```

Now, broken down by trial.
Summary across anticipation window.

```{r}
ms <- d %>%
  filter(t > -4000, t < 120) %>%
  group_by(lab, subid, trial_num, experiment_num) %>%
  summarise(target = mean(aoi == "target", na.rm = TRUE)) %>%
  group_by(trial_num, experiment_num) %>%
  langcog::multi_boot_standard(col = "target", na.rm = TRUE)


ggplot(ms, aes(x = trial_num, y = mean)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) + 
  geom_line() + 
  facet_grid(. ~ experiment_num)
```
  
   
Binned for cleaner curves

```{r}
ms <- d %>%
  mutate(block = ifelse(trial_num < 5, "Trials 1-4", "Trials 5-8")) %>%
  group_by(t, block, experiment_num) %>%
  summarise(target = mean(aoi == "target", na.rm = TRUE),
            distractor = mean(aoi == "distractor", na.rm = TRUE)) %>%
  gather(region, looking, target, distractor) 
  
ggplot(ms, aes(x = t, y = looking, col = region)) +
  geom_point() + 
  # geom_smooth(span = 2, se = FALSE) + 
  xlim(-4000 + 120, 4000 + 120) +
  geom_vline(xintercept = 120, col = "black", lty = 3) + 
  annotate("text", x = -3800, y = 1, col = "black",
            label = "Anticipation", hjust = 0) +
  annotate("text", x = 200, y = 1, col = "black", 
            label = "Reaction", hjust = 0) + 
  ggthemes::scale_color_solarized(name = "Area of Interest") + 
  xlab("Time (msec)") + 
  ylab("Proportion gaze in AOI") + 
  theme(legend.position = "bottom") + 
  facet_wrap(experiment_num~block)
```

And by lab:

```{r}
ms <- d %>%
  mutate(block = ifelse(trial_num < 5, 1, 2)) %>%
  group_by(t, lab, block, experiment_num) %>%
  summarise(target = mean(aoi == "target", na.rm = TRUE),
            distractor = mean(aoi == "distractor", na.rm = TRUE)) %>%
  gather(region, looking, target, distractor) 
  
ggplot(ms, aes(x = t, y = looking, col = region)) +
  geom_point() + 
  # geom_smooth(span = 2, se = FALSE) + 
  xlim(-4000 + 120, 4000 + 120) + 
  geom_vline(xintercept = 120, col = "red", lty = 2) +
  facet_grid(lab~block + experiment_num)
```

# Set up priors for Analyses 1 and 2

For Bayesian analyses below. We are using a weakly informed prior for all analyses.

```{r}
priors <-c(set_prior("normal(0, 2)", class = "Intercept"),
              set_prior("normal(0, 2)", class = "b"),
              set_prior("normal(0, .1)", class = "sd"),
              set_prior("lkj(2)", class = "L"))

null_prior <- c(set_prior("normal(0, 2)", class = "b"),
                set_prior("normal(0, .1)", class = "sd"),
                set_prior("lkj(2)", class = "L"))
```

```{r}
priors_diff <-c(set_prior("uniform(-.5, .5)", class = "Intercept"),
              set_prior("normal(0, .1)", class = "b"),
              set_prior("normal(0, .05)", class = "sd"),
              set_prior("lkj(2)", class = "L"))

null_prior_diff <- c(set_prior("normal(0, .1)", class = "b"),
                set_prior("normal(0, .05)", class = "sd"),
                set_prior("lkj(2)", class = "L"))
```

```{r include = FALSE}
priors_weaker <- c(set_prior("normal(0, 3)", class = "Intercept"),
              set_prior("normal(0, 3)", class = "b"),
              set_prior("normal(0, .5)", class = "sd"),
              set_prior("lkj(2)", class = "L"))

null_prior_weaker <- c(set_prior("normal(0, 3)", class = "b"),
                       set_prior("normal(0, .5)", class = "sd"),
                       set_prior("lkj(2)", class = "L"))

```

# Main analysis 1: First anticipatory look

## Bayesian First Look
Create a dataframe to identify the first look and see if the first look is >150ms (AT: change it to 150ms based on Dana's comment on RR)
Ref: Rayner, K., Smith, T. J., Malcolm, G. L., & Henderson, J. M. (2009). Eye Movements and Visual Encoding During Scene Perception. Psychological Science, 20(1), 6-10. doi:10.1111/j.1467-9280.2008.02243.x

```{r}
# get time and location of first look (either target or distractor)

df_t_first_aoi <- d %>% 
  # for now only look at exp1, and at window between bear disappearing and point of disambiguation (+120 to account for time to react)
  filter(., t >= -4000+120, t <= 120) %>% 
  # create variable for AOI in order to exploit rle, which handles NaN's neatly
    mutate(aoi_recode = ifelse(aoi == "other", NA, aoi)) %>%
  group_by(subid, trial_num) %>% 
    # 6 consecutive timepoints looking at target or distractor is the first look as we are using 150 ms
  mutate(first_look_aoi = rle(aoi_recode)$values[rle(aoi_recode)$lengths >= 6][1],
         first_look_t = t[sum(rle(aoi_recode)$lengths[0:(which.max(rle(aoi_recode)$lengths >= 6)-1)])+1]) %>% 
  ungroup()

# short df with first looks to check
first_looks_df <- df_t_first_aoi %>% 
  #select(subid, trial_num, first_look_aoi, first_look_t, age, experiment_num) %>% 
  group_by(subid, trial_num, experiment_num,lab) %>%
  summarize(aoi = unique(first_look_aoi)) %>% 
  mutate(aoi = case_when (is.na(aoi) ~ "other", 
                          TRUE ~ as.character(aoi))) 

```

Number of first look in differnet experiments, looks like pilot 1b outcome and no outcome conditions have similiar number of first look

Note that NA represents trials where the kid only looked at other places (not target/distractor) during the whole anticipatory window between -3880 to +120 ms

I checked online, didn't find any concensus of how to analyze the "other" looking. Different people have different decisions on how to treat the "other" looking in the analyses. 

I suggest removing "NA (other)" in the following analyses, as I think that looking at "distractor" and "other" are two different concepts. Theortically, we are interested in understanding whether kids looked at target more than distractor and we may not want to include the time when kids were bored and didn't pay attention to trials/simply did not understand the task. In addition, the number of cases when kids only looked at "other" is low across experiments, so we are good.
```{r}
first_looks_df %>% 
  group_by(aoi, experiment_num) %>% 
  count()
```


## Data visualization across different test trials


```{r}
### Pilot 1a kids
ggplot(data = filter(first_looks_df, experiment_num == "pilot_1a")) + 
  geom_bar(mapping = aes(x = aoi, y = ..prop.., group = 1, stat = "count")) + 
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(.~trial_num, ncol = 4)+
  labs(title = "Pilot 1a kids")
```


```{r}
### Pilot 1a adult
ggplot(data = filter(first_looks_df, experiment_num == "pilot_1a_adult")) + 
  geom_bar(mapping = aes(x = aoi, y = ..prop.., group = 1, stat = "count")) + 
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(.~trial_num, ncol = 4)+ 
  labs(title = "Pilot 1a adult")
```


```{r}
### Pilot 1b

pilot_1b_bar <- first_looks_df %>% 
  filter(experiment_num %in% c("pilot_1b_outcome", "pilot_1b_no_outcome"))

ggplot(data = pilot_1b_bar)  + 
  geom_bar(mapping = aes(x = aoi, y = ..prop.., group = 1, stat = "count")) + 
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(trial_num~experiment_num, ncol = 4) +
  labs(title = "Pilot 1b")
```

## Descriptive stats
Note that the following analyses removed NA (i.e., when kids looked at other all the time during the anticipatory window between -3880ms to +120ms)

Mean and sd of first look location in different trials. The means of all trials are above 50%

```{r}
mean_sd_aoi <- first_looks_df %>% 
  ungroup() %>% 
  filter(!is.na(aoi)) %>% 
  mutate(aoi_dummy = ifelse(aoi == "target", 1, 0)) %>% 
  group_by(trial_num, experiment_num) %>% 
  summarise(number_of_kids_each_trial = n(),
            mean(aoi_dummy),
            sd(aoi_dummy))

```

Data visualization

```{r}
ggplot(mean_sd_aoi, aes(x = trial_num, y = `mean(aoi_dummy)`)) +
  geom_line()+
  facet_grid(.~experiment_num)
```


## Mixed-level analysis: First look location

### Pilot 1a
```{r first_look_analysis}
first_looks_df_1a <- first_looks_df %>% 
  filter(experiment_num == "pilot_1a", !is.na(aoi)) %>% 
  mutate(aoi_dummy = ifelse(aoi == "target", 1, 0)) %>% 
  group_by(subid) %>% 
  mutate(trial_num_recoded = trial_num - 8) %>% 
  ungroup()
```


Pilot_1a_child: model_fit (Full model) (more info prior)
```{r}
full_first_look_1a <- brms::brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1a,
                          family = bernoulli(link = "logit"),
                          prior = priors,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 123)
  
summary(full_first_look_1a)
```


```{r include = FALSE}
#Pilot_1a_child: model_fit (Full model) (weaker info prior)
full_first_look_1a_weaker <- brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1a,
                          family = bernoulli(link = "logit"),
                          prior = priors_weaker,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 456)
  
summary(full_first_look_1a_weaker)
```

Pilot_1a_child: simpler model_fit (null model)
```{r}
null_first_look_1a_full <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1a,
                          family = bernoulli(link = "logit"),
                          prior = null_prior,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 789)
  
summary(null_first_look_1a_full)
```

```{r include = FALSE}
null_first_look_1a_weaker <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1a,
                          family = bernoulli(link = "logit"),
                          prior = null_prior_weaker,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 1)
  
summary(null_first_look_1a_weaker)
```

Calculate the marginal log likelihoods for each hypothese using Bridge sampling
```{r}
marloglik_full_pilot1a <- bridge_sampler(full_first_look_1a, silent = T)

marloglik_null_pilot1a <- bridge_sampler(null_first_look_1a_full, silent = T)
```

```{r include = FALSE}
marloglike_full_weaker_pilot1a <- bridge_sampler(full_first_look_1a_weaker, silent = T)

marloglike_null_weaker_pilot1a <- bridge_sampler(null_first_look_1a_weaker, silent = T)
```

Bayes factor
```{r}
BF_full_In_1a <- bayes_factor(marloglik_full_pilot1a, marloglik_null_pilot1a)

BF_full_In_1a
```

```{r include = FALSE}
BF_weaker_In_1a <- bayes_factor(marloglike_full_weaker_pilot1a, marloglike_null_weaker_pilot1a)

BF_weaker_In_1a
```

### Pilot 1a adult
```{r}
first_looks_df_1adult <- first_looks_df %>% 
  filter(experiment_num == "pilot_1a_adult", !is.na(aoi)) %>% 
  mutate(aoi_dummy = ifelse(aoi == "target", 1, 0)) %>% 
  group_by(subid) %>% 
  mutate(trial_num_recoded = trial_num - 8) %>% 
  ungroup()
```


Pilot_1a_adult: model_fit (Full model) (more info prior)
```{r}
full_first_look_1adult <- brms::brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1adult,
                          family = bernoulli(link = "logit"),
                          prior = priors,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 123,
                          control = list(adapt_delta = 0.91))
  
summary(full_first_look_1adult)
```


```{r include = FALSE}

#Pilot_1a_adult: model_fit (Full model) (weaker info prior)
full_first_look_1adult_weaker <- brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1adult,
                          family = bernoulli(link = "logit"),
                          prior = priors_weaker,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 456, control = list(adapt_delta = 0.99))
  
summary(full_first_look_1adult_weaker)
```

Pilot_1a_adult: simpler model_fit (null model)
```{r}
null_first_look_1adult_full <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1adult,
                          family = bernoulli(link = "logit"),
                          prior = null_prior,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 789, 
                          control = list(adapt_delta = 0.99))
  
summary(null_first_look_1adult_full)
```

```{r include = FALSE}
#Pilot_1a_adult: model_fit (null model) (weaker info prior)
null_first_look_1adult_weaker <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1adult,
                          family = bernoulli(link = "logit"),
                          prior = null_prior_weaker,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 1,
                          control = list(adapt_delta = 0.9912))
  
summary(null_first_look_1adult_weaker)
```

Calculate the marginal log likelihoods for each hypothese using Bridge sampling
```{r}
marloglik_full_pilot1adult <- bridge_sampler(full_first_look_1adult, silent = T)

marloglik_null_pilot1adult <- bridge_sampler(null_first_look_1adult_full, silent = T)
```

```{r include = FALSE}
marloglike_full_weaker_pilot1adult <- bridge_sampler(full_first_look_1adult_weaker, silent = T)

marloglike_null_weaker_pilot1adult <- bridge_sampler(null_first_look_1adult_weaker, silent = T)
```

Bayes factor
```{r}
BF_full_In_1adult <- bayes_factor(marloglik_full_pilot1adult, marloglik_null_pilot1adult)

BF_full_In_1adult
```

```{r include = FALSE}
BF_weaker_In_1adult <- bayes_factor(marloglike_full_weaker_pilot1adult, marloglike_null_weaker_pilot1adult)

BF_weaker_In_1adult
```

### Pilot 1b outcome
```{r}
first_looks_df_1b_o <- first_looks_df %>% 
  filter(experiment_num == "pilot_1b_outcome", !is.na(aoi)) %>% 
  mutate(aoi_dummy = ifelse(aoi == "target", 1, 0)) %>% 
  group_by(subid) %>% 
  mutate(trial_num_recoded = trial_num - 8) %>% 
  ungroup()
```


Pilot_1b_outcome: model_fit (Full model) (more info prior)
```{r}
full_first_look_1b_o <- brms::brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1b_o,
                          family = bernoulli(link = "logit"),
                          prior = priors,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 123)
  
summary(full_first_look_1b_o)
```


```{r include = FALSE}
#Pilot_1b_child: model_fit (Full model) (weaker info prior)
full_first_look_1b_weaker_o <- brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1b_o,
                          family = bernoulli(link = "logit"),
                          prior = priors_weaker,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 456)
  
summary(full_first_look_1b_weaker_o)
```

Pilot_1b_outcome: simpler model_fit (null model)
```{r}
null_first_look_1b_full_o <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1b_o,
                          family = bernoulli(link = "logit"),
                          prior = null_prior,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 789)
  
summary(null_first_look_1b_full_o)
```

```{r include = FALSE}
#Pilot_1b_child: model_fit (null model) (weaker info prior)
null_first_look_1b_weaker_o <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1b_o,
                          family = bernoulli(link = "logit"),
                          prior = null_prior_weaker,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 1, control = list(adapt_delta = 0.9))
  
summary(null_first_look_1b_weaker_o)
```

Calculate the marginal log likelihoods for each hypothese using Bridge sampling
```{r}
marloglik_full_pilot1b_o <- bridge_sampler(full_first_look_1b_o, silent = T)

marloglik_null_pilot1b_o <- bridge_sampler(null_first_look_1b_full_o, silent = T)
```

```{r include = FALSE}
marloglike_full_weaker_pilot1b_o <- bridge_sampler(full_first_look_1b_weaker_o, silent = T)

marloglike_null_weaker_pilot1b_o <- bridge_sampler(null_first_look_1b_weaker_o, silent = T)
```

Bayes factor
```{r}
BF_full_In_1b_o <- bayes_factor(marloglik_full_pilot1b_o, marloglik_null_pilot1b_o)

BF_full_In_1b_o
```


```{r include = FALSE}
BF_weaker_In_1b_o <- bayes_factor(marloglike_full_weaker_pilot1b_o, marloglike_null_weaker_pilot1b_o)

BF_weaker_In_1b_o
```

### Pilot 1b no outcome
```{r}
first_looks_df_1b_no <- first_looks_df %>% 
  filter(experiment_num == "pilot_1b_no_outcome", !is.na(aoi)) %>% 
  mutate(aoi_dummy = ifelse(aoi == "target", 1, 0)) %>% 
  group_by(subid) %>% 
  mutate(trial_num_recoded = trial_num - 8) %>% 
  ungroup()
```


Pilot_1b_no_outcome: model_fit (Full model) (more info prior)
```{r}
full_first_look_1b_no <- brms::brm(aoi_dummy ~ 1 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1b_no,
                          family = bernoulli(link = "logit"),
                          prior = priors,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 123)
  
summary(full_first_look_1b_no)
```

Pilot_1b_outcome: simpler model_fit (null model)
```{r}
null_first_look_1b_full_no <- brm(aoi_dummy ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                          data = first_looks_df_1b_no,
                          family = bernoulli(link = "logit"),
                          prior = null_prior,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000, 
                          iter = 2000, 
                          chains = 4, 
                          cores = 4,
                          seed = 789)
  
summary(null_first_look_1b_full_no)
```

Calculate the marginal log likelihoods for each hypothese using Bridge sampling
```{r}
marloglik_full_pilot1b_no <- bridge_sampler(full_first_look_1b_no, silent = T)

marloglik_null_pilot1b_no <- bridge_sampler(null_first_look_1b_full_no, silent = T)
```

Bayes factor
```{r}
BF_full_In_1b_no <- bayes_factor(marloglik_full_pilot1b_no, marloglik_null_pilot1b_no)

BF_full_In_1b_no
```

# Main analysis 2: Differential time looking analysis

This analysis explores whether kids looked at the target more than distractor during anticipatory period. 

## Data visualization across different test trials

```{r}
df_analysis_windowed <- d %>%  
  filter(t >= -4000+120 & t <= 120)
```

Pilot 1a kid 
```{r}
ggplot(data = filter(df_analysis_windowed, experiment_num == "pilot_1a")) + 
  geom_bar(mapping = aes(x = aoi, y = ..prop.., group = 1, stat = "count")) + 
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(.~trial_num, ncol = 4)
```

Pilot 1a adult
```{r}
ggplot(data = filter(df_analysis_windowed, experiment_num == "pilot_1a_adult")) + 
  geom_bar(mapping = aes(x = aoi, y = ..prop.., group = 1, stat = "count")) + 
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(.~trial_num, ncol = 4)
```

Pilot 1b :
```{r}
ggplot(data = filter(df_analysis_windowed, experiment_num %in% c("pilot_1b_outcome", "pilot_1b_no_outcome"))) + 
  geom_bar(mapping = aes(x = aoi, y = ..prop.., group = 1, stat = "count")) + 
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(trial_num~experiment_num, ncol = 4)
```

For proportion score, focus on target and distractor
```{r}
ms_proportion_trials <- df_analysis_windowed %>%
  group_by(t, experiment_num) %>%
  summarise(target = mean(aoi == "target", na.rm = TRUE),
            distractor = mean(aoi == "distractor", na.rm = TRUE)) %>%
  mutate(proportion_to_target = target / (target + distractor)) 
 

ggplot(ms_proportion_trials,
       aes(x = t, y = proportion_to_target)) +
  geom_point(alpha = 0.3) +
  ylim(0,1) +
  # geom_smooth(span = 2, se = FALSE) +
  xlim(-4000+120, 4120) +
  geom_vline(xintercept = 120, col = "red", lty = 2) +
  geom_text(x = -4000, y = .95, group = 1, col = "black",
            label = "Anticipation", hjust = 0 ) +
  geom_text(x = 200, y = .95, group = 1, col = "black",
            label = "Reaction", hjust = 0 )+
  facet_wrap(~experiment_num)
```

## Traditional approach - Mixed level approach

```{r}
ms_proportion_each_trial <- df_analysis_windowed %>%
  group_by(lab, subid, experiment_num, trial_num) %>%
  summarise(target = mean(aoi == "target", na.rm = TRUE),
            distractor = mean(aoi == "distractor", na.rm = TRUE)) %>%
  mutate(trial_num_recoded = trial_num - 8,
         proportion_target = target/(target + distractor),
         proportion_target_c = proportion_target - 0.5) %>%
  filter(!is.na(proportion_target)) %>% 
  ungroup()

```

## Pilot 1a
Mixed effect model for pilot 1a (kids) - full model (more info prior)
```{r}
df_ms_proportion_1a <- ms_proportion_each_trial %>% 
  filter(experiment_num == "pilot_1a")

m_lmer_full_1a <- brm(proportion_target_c ~ trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                   data=df_ms_proportion_1a, 
                   family = gaussian(), 
                           prior = priors_diff,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000,
                          iter = 2000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.95),
                          seed = 1)

m_lmer_full_1a
```


Null model pilot 1a (kid) - (more info prior)
```{r}

m_lmer_null_1a <- brm(proportion_target_c ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                   data=df_ms_proportion_1a, 
                   family = gaussian(), 
                           prior = null_prior_diff,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000,
                          iter = 2000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.95),#need to adjust the delta value to a very high number in order to get rid of divergence messages
                          seed = 2)

m_lmer_null_1a
```

Calculate the marginal log likelihoods for each hypothese using Bridge sampling
```{r}
prop_marloglik_full_pilot1a <- bridge_sampler(m_lmer_full_1a, silent = T)

prop_marloglik_null_pilot1a <- bridge_sampler(m_lmer_null_1a, silent = T)
```

Bayes factor
```{r}
BF_prop_In_more_info_1a <- bayes_factor(m_lmer_full_1a, m_lmer_null_1a)

BF_prop_In_more_info_1a
```


## Pilot 1a adult
Mixed effect model for pilot 1a (adult) - full model (more info prior)
```{r}
df_ms_proportion_1adult <- ms_proportion_each_trial %>% 
  filter(experiment_num == "pilot_1a_adult")

m_lmer_full_1adult <- brm(proportion_target_c ~ trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                   data=df_ms_proportion_1adult, 
                   family = gaussian(), 
                           prior = priors_diff,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000,
                          iter = 2000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.996),
                          seed = 1)

m_lmer_full_1adult
```

Null model pilot 1a (adult) - (more info prior)
```{r}

m_lmer_null_1adult <- brm(proportion_target_c ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                   data=df_ms_proportion_1adult, 
                   family = gaussian(), 
                           prior = null_prior_diff,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000,
                          iter = 2000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.9995),#need to adjust the delta value to a very high number in order to get rid of divergence messages
                          seed = 2)

m_lmer_null_1adult
```


Bayes factor
```{r}
BF_prop_In_more_info_adult <- bayes_factor(m_lmer_full_1adult, m_lmer_null_1adult)

BF_prop_In_more_info_adult
```

## Pilot 1b outcome 
Mixed effect model for pilot 1b (kids) - full model (more info prior)
```{r}
df_ms_proportion_1b_o <- ms_proportion_each_trial %>% 
  filter(experiment_num == "pilot_1b_outcome") %>%
  mutate(trial_num_recoded = (trial_num_recoded + 4))

m_lmer_full_1b_o <- brm(proportion_target_c ~ trial_num_recoded + 
                          (trial_num_recoded | lab) +
                          (trial_num_recoded | subid),
                   data=df_ms_proportion_1b_o, 
                   family = gaussian(), 
                           prior = priors_diff,
                          save_pars = save_pars(all = TRUE),
                          warmup = 20000,
                          iter = 40000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.99),
                          seed = 1)

m_lmer_full_1b_o
```

Null model pilot 1b (kid) - (more info prior)
```{r}

m_lmer_null_1b_o <- brm(proportion_target_c ~ 0 + trial_num_recoded +
                          (trial_num_recoded | lab) +
                          (trial_num_recoded | subid),
                   data=df_ms_proportion_1b_o, 
                   family = gaussian(), 
                           prior = null_prior,
                          save_pars = save_pars(all = TRUE),
                          warmup = 20000,
                          iter = 40000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.9999),#need to adjust the delta value to a very high number in order to get rid of divergence messages
                          seed = 2)

m_lmer_null_1b_o
```

Bayes factor
```{r}
BF_prop_In_more_info_1b_o <- bayes_factor(m_lmer_full_1b_o, m_lmer_null_1b_o)

BF_prop_In_more_info_1b_o
```

## Pilot 1b no outcome 
Mixed effect model for pilot 1b (no outcome) - full model (more info prior)
```{r}
df_ms_proportion_1b_no <- ms_proportion_each_trial %>% 
  filter(experiment_num == "pilot_1b_no_outcome")

m_lmer_full_1b_no <- brm(proportion_target_c ~ trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                   data=df_ms_proportion_1b_no, 
                   family = gaussian(), 
                           prior = priors,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000,
                          iter = 2000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.995),
                          seed = 1)

m_lmer_full_1b_no
```

Null model pilot 1b (no outcome) - (more info prior)
```{r}

m_lmer_null_1b_no <- brm(proportion_target_c ~ 0 + trial_num_recoded + (trial_num_recoded | lab) + (trial_num_recoded | subid),
                   data=df_ms_proportion_1b_no, 
                   family = gaussian(), 
                           prior = null_prior,
                          save_pars = save_pars(all = TRUE),
                          warmup = 1000,
                          iter = 2000,
                          chains = 4,
                          cores = 4,
                          control = list(adapt_delta = 0.9999),#need to adjust the delta value to a very high number in order to get rid of divergence messages
                          seed = 2)

m_lmer_null_1b_no
```

Calculate the marginal log likelihoods for each hypothese using Bridge sampling
```{r}
prop_marloglik_full_pilot1b_no <- bridge_sampler(m_lmer_full_1b_no, silent = T)

prop_marloglik_null_pilot1b_no <- bridge_sampler(m_lmer_null_1b_no, silent = T)
```

Bayes factor
```{r}
BF_prop_In_more_info_1b_no <- bayes_factor(prop_marloglik_full_pilot1b_no, prop_marloglik_null_pilot1b_no)

BF_prop_In_more_info_1b_no
```

## Mirman growth curve analysis

Create dataset with sub-sampled counts for growth curve analysis a la Mirman (2014). 

```{r, eval = FALSE, include = FALSE}
POLY_DEG <- 2
ms_timecourse <- df_analysis_windowed %>%
  mutate(trial_id = as.character(paste(lab, experiment_num, trial_id)),
         trial_num_recoded = trial_num - 8, 
         t_window = as.numeric(as.factor(cut(t, breaks=10)))
  ) %>%
  group_by(lab, trial_id, trial_num_recoded, subid, t_window) %>%
  summarise(aoi_target = sum(aoi == "target"),
            aoi_distractor = sum(aoi == "distractor")) %>%
  mutate(target = case_when(aoi_target > aoi_distractor ~ 1,
                            aoi_distractor > aoi_target ~ 0
                            )) %>%
  filter(is.na(target) == F)

group_by(ms_timecourse, lab, trial_id, subid) %>%
  mutate(lag.target = lag(target)) %>%
  na.omit() %>%
  summarise(autoc = cor(target, lag.target)) %>%
  group_by() %>%
  summarise(mean.c = mean(autoc,na.rm=T))

sample_n(ungroup(ms_timecourse), nrow(ms_timecourse)) %>%
  group_by(lab, trial_id, subid) %>%
  mutate(lag.target = lag(target)) %>%
  na.omit() %>%
  summarise(autoc = cor(target, lag.target)) %>%
  group_by() %>%
  summarise(mean.c = mean(autoc,na.rm=T))



ops <- poly(unique(ms_timecourse$t_window), POLY_DEG)
ops_tibble <- tibble(ot1 = ops[,1], 
                     ot2 = ops[,2],
                     # ot3 = ops[,3], 
                     t_window = unique(ms_timecourse$t_window))


ms_timecourse <- left_join(ms_timecourse, ops_tibble)
```


```{r, eval = FALSE, include = FALSE}

priors <-c(set_prior("normal(0, .5)", class = "Intercept"),
              set_prior("normal(0, .5)", class = "b"),
              set_prior("normal(0, .1)", class = "sd"),
              set_prior("lkj(2)", class = "L"))

m.full <- brm(target ~ (ot1 + ot2) * trial_num_recoded +
                  (ot1 + ot2 | trial_id) +
                  ((ot1 + ot2) * trial_num_recoded | subid) +
                ((ot1 + ot2) * trial_num_recoded | lab),
              family = "bernoulli",
              chains = 4,
              cores=4,
              prior= priors,
              data = ms_timecourse)



ms_timecourse$fit <- fitted(m.full)[, "Estimate"]
ms_timecourse %>%
  group_by(lab, trial_id) %>%
  mutate(resid = fit - target,
         lag.resid = lag(resid)) %>%
  ggplot(data=., aes(x=lag.resid, y=resid)) + 
  geom_point()
ms_timecourse %>%
  group_by(lab, trial_id) %>%
  mutate(resid = fit - target,
         lag.resid = lag(resid)) %>%
  ggplot(data=., aes(x=t_window, y=resid)) + 
  geom_point()

ms_timecourse %>%
  group_by(lab, trial_id) %>%
  mutate(resid = fit - target,
         lag.resid = lag(resid)) %>%
  ungroup() %>%
  na.omit() %>%
  summarise(c=cor(resid, lag.resid))

hist(ms_timecourse$fit)
hist(ms_timecourse$target)
```

```{r, eval = FALSE, include = FALSE}
ggplot(ms_timecourse, aes(x = t_window, y = target)) + 
  stat_summary(fun.data = mean_se, geom="pointrange") + 
  stat_summary(aes(y = fit), fun = mean, geom = "line")
```

